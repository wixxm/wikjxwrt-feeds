name: Update Feeds & Git Push

on:
  workflow_dispatch:  # 允许手动触发
  schedule:
    - cron: "0 2 * * *"  # 每天 UTC 02:00 自动执行

jobs:
  update-feeds:
    runs-on: ubuntu-latest

    steps:
      - name: 检查出仓库代码
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # 确保获取完整历史记录

      - name: 配置 Git 用户信息
        run: |
          git config --global user.name "wixxm"
          git config --global user.email "419691642@qq.com"

      - name: 🔑 设置 Git 远程 URL（使用 Token 认证）
        run: |
          REPO_URL="https://x-access-token:${{ secrets.OPENWRT_WORKFLOW_TOKEN }}@github.com/wixxm/wikjxwrt-feeds.git"
          git remote set-url origin "$REPO_URL"

      - name: Update Feeds
        run: |
          export mirror=raw.githubusercontent.com/wixxm/wikjxwrt-feeds/config
          curl -sO https://$mirror/wikjxwrt-feeds.sh
          bash wikjxwrt-feeds.sh
          rm -f wikjxwrt-feeds.sh

      - name: 确保 Git 处于正确的分支
        run: |
          git checkout main
          git pull origin main  # 确保获取最新变更

      - name: 复制 `TARGET_DIR` 到 GitHub 工作目录
        run: |
          TARGET_DIR="/opt/github/wikjxwrt-packages"
          if [ -d "$TARGET_DIR" ]; then
            rsync -av --exclude='.git' "$TARGET_DIR/" .
          else
            echo "⚠️ TARGET_DIR 不存在，跳过同步"
          fi

      - name: 确保 Git 有变更
        run: |
          git add .
          if git diff --cached --quiet; then
            echo "✅ No changes detected, skipping commit and push."
            exit 0
          fi

      - name: 获取当前时间戳
        run: echo "TIMESTAMP=$(TZ='Asia/Hong_Kong' date +"%Y-%m-%d %H:%M:%S")" >> $GITHUB_ENV

      - name: 生成随机 Emoji 符号
        run: |
          symbols=("🌈" "✨" "🚀" "🔥" "🌟" "⚡" "🎉" "🌻" "🔧" "💡")
          random_symbol=${symbols[$RANDOM % ${#symbols[@]}]}
          echo "RANDOM_SYMBOL=$random_symbol" >> $GITHUB_ENV

      - name: 📝 提交并推送更改
        run: |
          commit_message="$RANDOM_SYMBOL Sync - $TIMESTAMP"
          echo "📝 Committing changes with message: '$commit_message'"
          if git diff --quiet && git diff --cached --quiet; then
            echo "✅ No changes to commit. Skipping commit and push."
            exit 0
          fi

          git commit -m "$commit_message"

          echo "🚀 Pushing changes to GitHub..."
          git push origin main || (echo "❌ Push failed! Trying PAT_TOKEN..." && \
            git remote set-url origin "https://x-access-token:${{ secrets.OPENWRT_WORKFLOW_TOKEN }}@github.com/wixxm/wikjxwrt-feeds.git" && \
            git push origin main) || (echo "❌ Push failed! Check permissions." && exit 1)
