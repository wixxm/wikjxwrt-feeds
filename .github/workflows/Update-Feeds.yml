name: Update Feeds & Git Push

on:
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
  schedule:
    - cron: "0 2 * * *"  # æ¯å¤© UTC 02:00 è‡ªåŠ¨æ‰§è¡Œ

jobs:
  update-feeds:
    runs-on: ubuntu-latest

    steps:
      - name: æ£€æŸ¥å‡ºä»“åº“ä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # ç¡®ä¿è·å–å®Œæ•´å†å²è®°å½•

      - name: é…ç½® Git ç”¨æˆ·ä¿¡æ¯
        run: |
          git config --global user.name "wixxm"
          git config --global user.email "419691642@qq.com"

      - name: ğŸ”‘ è®¾ç½® Git è¿œç¨‹ URLï¼ˆä½¿ç”¨ Token è®¤è¯ï¼‰
        run: |
          REPO_URL="https://x-access-token:${{ secrets.OPENWRT_WORKFLOW_TOKEN }}@github.com/wixxm/wikjxwrt-feeds.git"
          git remote set-url origin "$REPO_URL"

      - name: Update Feeds
        run: |
          export mirror=raw.githubusercontent.com/wixxm/wikjxwrt-feeds/config
          curl -sO https://$mirror/wikjxwrt-feeds.sh
          bash wikjxwrt-feeds.sh
          rm -f wikjxwrt-feeds.sh

      - name: ç¡®ä¿ Git å¤„äºæ­£ç¡®çš„åˆ†æ”¯
        run: |
          git checkout main
          git pull origin main  # ç¡®ä¿è·å–æœ€æ–°å˜æ›´

      - name: å¤åˆ¶ `TARGET_DIR` åˆ° GitHub å·¥ä½œç›®å½•
        run: |
          TARGET_DIR="/opt/github/wikjxwrt-packages"
          if [ -d "$TARGET_DIR" ]; then
            rsync -av --exclude='.git' "$TARGET_DIR/" .
          else
            echo "âš ï¸ TARGET_DIR ä¸å­˜åœ¨ï¼Œè·³è¿‡åŒæ­¥"
          fi

      - name: ç¡®ä¿ Git æœ‰å˜æ›´
        run: |
          git add .
          if git diff --cached --quiet; then
            echo "âœ… No changes detected, skipping commit and push."
            exit 0
          fi

      - name: è·å–å½“å‰æ—¶é—´æˆ³
        run: echo "TIMESTAMP=$(TZ='Asia/Hong_Kong' date +"%Y-%m-%d %H:%M:%S")" >> $GITHUB_ENV

      - name: ç”Ÿæˆéšæœº Emoji ç¬¦å·
        run: |
          symbols=("ğŸŒˆ" "âœ¨" "ğŸš€" "ğŸ”¥" "ğŸŒŸ" "âš¡" "ğŸ‰" "ğŸŒ»" "ğŸ”§" "ğŸ’¡")
          random_symbol=${symbols[$RANDOM % ${#symbols[@]}]}
          echo "RANDOM_SYMBOL=$random_symbol" >> $GITHUB_ENV

      - name: ğŸ“ æäº¤å¹¶æ¨é€æ›´æ”¹
        run: |
          commit_message="$RANDOM_SYMBOL Sync - $TIMESTAMP"
          echo "ğŸ“ Committing changes with message: '$commit_message'"
          if git diff --quiet && git diff --cached --quiet; then
            echo "âœ… No changes to commit. Skipping commit and push."
            exit 0
          fi

          git commit -m "$commit_message"

          echo "ğŸš€ Pushing changes to GitHub..."
          git push origin main || (echo "âŒ Push failed! Trying PAT_TOKEN..." && \
            git remote set-url origin "https://x-access-token:${{ secrets.OPENWRT_WORKFLOW_TOKEN }}@github.com/wixxm/wikjxwrt-feeds.git" && \
            git push origin main) || (echo "âŒ Push failed! Check permissions." && exit 1)
